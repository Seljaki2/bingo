<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Bingo ‚Äî Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes wrongFlash {

            0%,
            100% {
                background-color: #ef4444;
            }

            50% {
                background-color: #dc2626;
            }
        }

        @keyframes correctFlash {

            0%,
            100% {
                background-color: #22c55e;
            }

            50% {
                background-color: #16a34a;
            }
        }
    </style>
</head>

<body
    class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-700 p-6 lg:p-10 font-sans">
    <main class="max-w-[1400px] mx-auto space-y-8">
        <!-- Header -->
        <div class="flex items-center justify-between">
            <h1 class="text-3xl font-bold text-center flex-1 text-gray-800 dark:text-white">Quiz Bingo! üéØ</h1>
            <button onclick="window.location.href='index.html'"
                class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-700 transition-colors font-semibold dark:text-white">
                Nazaj na meni
            </button>
        </div>
        <!-- Question Card -->
        <section class="bg-white dark:bg-gray-800 shadow-2xl rounded-2xl p-6 space-y-6">
            <div class="flex items-center justify-between">
                <span id="turn" class="px-3 py-1 rounded-full bg-blue-500 text-white font-medium"></span>
                <span class="px-3 py-1 rounded-full bg-gray-200 font-medium">‚è±Ô∏è 30s</span>
            </div>

            <!-- Progress bar -->
            <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
                <div class="bg-blue-500 h-2 timerBar" style="width: 100%;"></div>
            </div>
            <div class="flex justify-center">
                <img src="" alt="Question Image" class="hidden" width="300px" />
            </div>
            <!-- Question -->
            <div
                class="bg-gradient-to-r from-green-100 to-emerald-100 dark:from-green-900 dark:to-emerald-900 p-6 rounded-lg text-center dark:text-white">
                <p id="question" class="text-lg font-medium"></p>
            </div>

            <!-- Answer buttons -->
            <div id="answers" class="grid grid-cols-2 gap-4 "></div>
        </section>

        <!-- Bingo Boards (dynamic) -->
        <section id="boards" class="grid gap-6 justify-items-center"></section>

        <div class="text-center text-sm text-gray-500 dark:text-gray-400 mt-8">
            <span class="font-semibold">Digitalna Brigada & Seljaki2</span>
        </div>
        <script>
            let game = [];
            let gameData = [];
            let parameters = {};
            let currentAssigned = null;
            let currentSelectedTile = null;
            let isCorrectAnswer = false;
            let questionIndex = -1;
            let limitIndex = 20;
            let questionImage = document.querySelector("img");
            let playerIds = [];
            let playerNames = [];
            let playerCount = 0;
            let boards = [];
            let currentPlayer = 0;
            let playerScores = [];
            let gameOver = false;
            let toastTimer = null;


            let timerInterval;
            let questionTime = 30;
            let timeRemaining;
            const progressBar = document.querySelector('.timerBar');
            const timerDisplay = document.querySelector('.px-3.py-1.bg-gray-200');

            function renderAnswerButtons(options) {
                const container = document.getElementById('answers');
                container.innerHTML = '';
                const count = Math.max(2, Math.min(4, options.length || 2));
                container.className = `grid grid-cols-2 gap-4`;
                for (let i = 0; i < count; i++) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.id = String(i);
                    btn.className = 'qButtons py-4 border rounded-lg hover:scale-105 transition-transform flex items-center justify-center gap-2 dark:text-white';
                    btn.innerText = options[i] ?? '';
                    btn.addEventListener('click', selectedAnswer, false);
                    container.appendChild(btn);
                }

            }
            window.onload = function () {
                enterData();
            };
            async function enterData() {
                console.log("Loading game data...");
                try {
                    parameters = JSON.parse(localStorage.getItem('parameters') || 'null');
                } catch (e) {
                    console.error('Failed to parse parameters', e);
                    parameters = null;
                }

                if (!parameters || !Array.isArray(parameters.players) || parameters.players.length === 0) {
                    alert('No players selected ‚Äî please return to the menu and add players.');
                    window.location.href = 'index.html';
                    return;
                }

                if (!parameters.grade || !Array.isArray(parameters.category) || parameters.category.length === 0) {
                    alert('Missing grade or categories ‚Äî please configure the game from the menu.');
                    window.location.href = 'index.html';
                    return;
                }

                playerCount = parameters.players.length;
                for (let i = 0; i < playerCount; i++) {
                    const p = parameters.players[i];
                    const idNum = Number(p?.id);
                    if (!Number.isFinite(idNum)) {
                        alert('One or more selected players do not have a valid user id. Please login/register players.');
                        window.location.href = 'index.html';
                        return;
                    }
                    playerIds.push(idNum);
                    playerNames.push(`${p.first_name} ${p.last_name}`);
                }

                console.log(parameters.players);

                try {
                    const menu = await window.api.loadMenu();
                    const ageGroups = (menu && menu.ageGroups) || [];
                    const selectedAge = ageGroups.find(a => String(a.id) === String(parameters.grade) || a.id === parameters.grade);
                    if (selectedAge && typeof selectedAge.min_age === 'number' && typeof selectedAge.max_age === 'number') {
                        questionTime = computeQuestionTime(selectedAge.min_age, selectedAge.max_age);
                    } else {
                        questionTime = 30;
                    }
                } catch (e) {
                    console.warn('Failed to load age groups for timing, using default:', e);
                    questionTime = 30;
                }

                const res = await window.api.startGame(parameters.grade, parameters.category, playerIds);
                if (!res || res.error) {
                    console.error('startGame error', res?.error);
                    alert('Failed to start game: ' + (res?.error || 'unknown'));
                    window.location.href = 'index.html';
                    return;
                }

                game = res;
                gameData = Array.isArray(game.questions) ? game.questions : [];

                if (!gameData.length) {
                    alert('No questions returned for the selected grade/categories. Please add questions or choose different options.');
                    window.location.href = 'index.html';
                    return;
                }

                boards = (game.players || []).map(p => p.board || createEmptyBoard());
                playerScores = (game.players || []).map(p => Number.isFinite(p.score) ? p.score : 0);
                console.log(gameData);
                await shuffle(gameData);
                console.log("Zmesano: ", gameData);
                limitIndex = gameData.length - 1;
                renderBoards();
                play();
                startTimer();
                return;
            }

            function computeQuestionTime(minAge, maxAge) {
                const mid = (Number(minAge) + Number(maxAge)) / 2;
                if (Number.isNaN(mid)) return 30;
                if (mid <= 10) return 45;
                if (mid <= 12) return 40;
                if (mid <= 15) return 35;
                if (mid <= 18) return 30;
                if (mid <= 25) return 25;
                return 20;
            }
            function play() {
                if (gameOver) return;
                questionIndex++;
                if (questionIndex > limitIndex) {
                    questionIndex = 0;
                }
                const imgPath = gameData[questionIndex].image_path;
                if (imgPath) {
                    questionImage.classList.remove("hidden");
                    if (typeof imgPath === 'string' && imgPath.startsWith('data:')) {
                        questionImage.src = imgPath;
                    } else {
                        questionImage.src = "./images/" + imgPath;
                    }
                } else {
                    questionImage.classList.add("hidden");
                }
                currentPlayer = (currentPlayer + 1) % playerCount;
                document.getElementById("turn").innerText = playerNames[currentPlayer] + " je na vrsti";
                highlightTurn(currentPlayer);
                document.getElementById("question").innerText = gameData[questionIndex].text;
                renderAnswerButtons(gameData[questionIndex].options || []);
                assignTileForQuestion();
                startTimer();
            }

            async function selectedAnswer(event) {
                const button = event.target;
                if (gameOver) return;
                const pIdx = currentPlayer;
                console.log(pIdx, gameData[questionIndex].id, parseInt(button.id))
                button.classList.add("border-blue-500", "shadow-md", "selected");
                try {
                    disableAnswerButtons();
                    const timeInfo = { timeRemaining: Number.isFinite(timeRemaining) ? timeRemaining : null, questionTime: Number.isFinite(questionTime) ? questionTime : null };
                    const result = await window.api.answer(pIdx, gameData[questionIndex].id, parseInt(button.id), currentSelectedTile, timeInfo);
                    isCorrectAnswer = !!result?.correct;
                    if (Array.isArray(result?.board)) {
                        boards[pIdx] = result.board;
                        if (result && typeof result.pointsAwarded === 'number') {
                            playerScores[pIdx] = (playerScores[pIdx] || 0) + result.pointsAwarded;
                        }
                        if (result && result.bingo) {
                            playerScores[pIdx] = (playerScores[pIdx] || 0) + 100;
                        }
                        updateBoard(pIdx);
                    }
                    if (isCorrectAnswer) {
                        button.style.animation = "correctFlash 0.6s ease-in-out 2";
                        if (result && typeof result.pointsAwarded === 'number') {
                            showToast(`+${result.pointsAwarded} toƒçk`, 'success');
                        } else {
                            showToast(`+10 toƒçk`, 'success');
                        }
                    } else {
                        button.style.animation = "wrongFlash 0.6s ease-in-out 2";
                        if (gameData[questionIndex]) {
                            const correctIndex = gameData[questionIndex].correct_answer;
                            console.log('Wrong answer selected. Correct index:', correctIndex, 'Question:', gameData[questionIndex]);
                            const correctBtn = document.getElementById(String(correctIndex));
                            console.log('Correct button found:', correctBtn);
                            if (correctBtn) {
                                correctBtn.classList.remove('opacity-60');
                                correctBtn.style.animation = "correctFlash 0.6s ease-in-out 2";
                                console.log('Applied animation to correct button');
                            }
                        }
                    }
                    if (result?.bingo) {
                        await endGame(pIdx);
                    }
                } catch (e) {
                    console.error('answer error', e);
                    isCorrectAnswer = false;
                }
                setTimeout(function () {
                    if (!gameOver) play();
                    console.log(isCorrectAnswer);
                    button.classList.remove("border-blue-500", "shadow-md", "selected");
                    button.style.animation = "";
                    button.style.color = '';
                    if (!isCorrectAnswer && gameData[questionIndex]) {
                        const correctIndex = gameData[questionIndex].correct_answer;
                        const correctBtn = document.getElementById(String(correctIndex));
                        if (correctBtn) {
                            correctBtn.style.animation = "";
                            correctBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                        }
                    }
                    enableAnswerButtons();
                }, 1000);
            }

            function shuffle(array) {
                let currentIndex = array.length;
                while (currentIndex != 0) {
                    let randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [
                        array[randomIndex], array[currentIndex]];
                }
            }

            function startTimer() {
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                if (gameOver) return;
                timeRemaining = Number.isFinite(questionTime) ? questionTime : 30;
                updateTimerDisplay(timeRemaining);
                updateProgressBar(timeRemaining);
                timerInterval = setInterval(function () {
                    timeRemaining--;
                    updateTimerDisplay(timeRemaining);
                    updateProgressBar(timeRemaining);

                    if (timeRemaining <= 0 && !gameOver) {
                        clearInterval(timerInterval);
                        play();
                    }
                }, 1000);
            }

            function updateTimerDisplay(time) {
                timerDisplay.innerText = `‚è±Ô∏è ${time}s`;
            }

            function updateProgressBar(time) {
                if (time <= 15 && time > 10) {
                    progressBar.classList.add("bg-orange-500");
                    progressBar.classList.remove("bg-blue-500");
                } else if (time <= 10) {
                    progressBar.classList.add("bg-rose-500");
                    progressBar.classList.remove("bg-orange-500");
                } else {
                    progressBar.classList.add("bg-blue-500");
                    progressBar.classList.remove("bg-rose-500");
                }
                const percentage = (time / 30) * 100;
                progressBar.style.width = `${percentage}%`;
            }

            // --------- Boards rendering ----------
            function renderBoards() {
                const container = document.getElementById('boards');
                container.innerHTML = '';
                container.style.gridTemplateColumns = `repeat(auto-fit, minmax(260px, 1fr))`;
                playerNames.forEach((name, idx) => {
                    const panel = document.createElement('div');
                    panel.className = 'w-full max-w-[420px] p-4 rounded-2xl bg-white dark:bg-gray-800 shadow-md dark:shadow-lg transition-all';
                    panel.setAttribute('data-player', idx.toString());
                    panel.innerHTML = `
                                        <div class="mb-3 flex items-center justify-between">
                                            <h3 class="flex items-center gap-2 font-semibold text-gray-800 dark:text-white">
                                                <span class="w-3 h-3 rounded-full ${idx === 0 ? 'bg-blue-500 dark:bg-blue-400' : 'bg-green-500 dark:bg-green-400'}"></span>
                                                ${name}
                                                <span class="ml-3 inline-block px-3 py-1 rounded-full bg-blue-500 dark:bg-blue-600 text-white text-sm font-semibold score-badge">${playerScores[idx] ?? 0}</span>
                                            </h3>
                                            <span class="turn-badge hidden px-2 py-1 rounded-full bg-green-500 dark:bg-green-400 text-white text-xs font-semibold">Ti si na vrsti‚ö°</span>
                                        </div>
                                        <div class="grid grid-cols-5 gap-2 board-grid"></div>`;
                    container.appendChild(panel);
                    drawBoardCells(panel.querySelector('.board-grid'), boards[idx] || createEmptyBoard());
                });
                highlightTurn(currentPlayer);
            }

            function createEmptyBoard() {
                const b = Array.from({ length: 5 }, () => Array(5).fill(false));
                b[2][2] = true; // free center
                return b;
            }

            function drawBoardCells(gridEl, board) {
                gridEl.innerHTML = '';
                let n = 1;
                for (let r = 0; r < 5; r++) {
                    for (let c = 0; c < 5; c++) {
                        const selected = board?.[r]?.[c];
                        const isCenter = r === 2 && c === 2;
                        const cell = document.createElement('div');
                        const base = ['aspect-square', 'rounded-lg', 'flex', 'items-center', 'justify-center'];
                        if (selected) {
                            if (isCenter) base.push('bg-yellow-400', 'dark:bg-yellow-500', 'text-white');
                            else base.push('bg-blue-500', 'dark:bg-blue-600', 'text-white', 'shadow');
                        } else {
                            base.push('bg-white', 'dark:bg-gray-700', 'border-2', 'border-gray-200', 'dark:border-gray-600', 'text-gray-800', 'dark:text-white');
                        }
                        cell.className = base.join(' ');
                        cell.textContent = isCenter ? '‚òÖ' : String(n);
                        cell.dataset.r = String(r);
                        cell.dataset.c = String(c);
                        gridEl.appendChild(cell);
                        n++;
                    }
                }
            }

            function updateBoard(playerIdx) {
                const grid = document.querySelector(`[data-player="${playerIdx}"] .board-grid`);
                if (grid) drawBoardCells(grid, boards[playerIdx]);
                if (playerIdx === currentPlayer) updateBoardSelectionUI(playerIdx);
                try {
                    const panel = document.querySelector(`[data-player="${playerIdx}"]`);
                    if (panel) {
                        const scoreEl = panel.querySelector('.score-badge');
                        if (scoreEl) scoreEl.textContent = String(playerScores[playerIdx] ?? 0);
                    }
                } catch (e) {
                    console.warn('Failed to update score display', e);
                }
            }

            function assignTileForQuestion() {
                currentAssigned = null;
                currentSelectedTile = null;
                if (!gameData[questionIndex]) return;
                const axis = Math.random() < 0.5 ? 'row' : 'col';
                const index = Math.floor(Math.random() * 5);
                currentAssigned = { axis, index };
                const board = boards[currentPlayer] || createEmptyBoard();
                const candidates = [];
                for (let i = 0; i < 5; i++) {
                    const r = axis === 'row' ? index : i;
                    const c = axis === 'col' ? index : i;
                    if (!board[r][c]) candidates.push({ r, c });
                }
                if (candidates.length === 0) {
                    for (let r = 0; r < 5; r++) for (let c = 0; c < 5; c++) if (!board[r][c]) candidates.push({ r, c });
                }
                if (candidates.length > 0) {
                    const choice = candidates[Math.floor(Math.random() * candidates.length)];
                    currentSelectedTile = choice;
                }
                updateBoardSelectionUI(currentPlayer);
            }

            function updateBoardSelectionUI(playerIdx) {
                document.querySelectorAll('#boards .board-grid').forEach(grid => {
                    grid.querySelectorAll('div').forEach(cell => {
                        cell.classList.remove('allowed', 'chosen', 'ring-4', 'ring-blue-500', 'cursor-pointer', 'ring-2', 'ring-green-400');
                    });
                });

                if (gameOver) return;
                if (playerIdx !== currentPlayer) return;
                const grid = document.querySelector(`[data-player="${playerIdx}"] .board-grid`);
                if (!grid) return;
                grid.querySelectorAll('div').forEach(cell => {
                    const newNode = cell.cloneNode(true);
                    cell.parentNode.replaceChild(newNode, cell);
                });
                const freshGrid = document.querySelector(`[data-player="${playerIdx}"] .board-grid`);
                freshGrid.querySelectorAll('div').forEach(cell => {
                    const r = parseInt(cell.dataset.r, 10);
                    const c = parseInt(cell.dataset.c, 10);
                    const occupied = !!boards[playerIdx]?.[r]?.[c];
                    if (occupied) {
                        cell.classList.add('opacity-60');
                        return;
                    }
                    if (currentAssigned) {
                        const { axis, index } = currentAssigned;
                        const inAssigned = (axis === 'row' && r === index) || (axis === 'col' && c === index);
                        if (inAssigned) {
                            cell.classList.add('allowed', 'cursor-pointer', 'ring-2', 'ring-green-400', 'dark:ring-green-300');
                            if (currentSelectedTile && currentSelectedTile.r === r && currentSelectedTile.c === c) {
                                cell.classList.add('chosen', 'ring-4', 'ring-blue-500', 'dark:ring-blue-400');
                            } else {
                                cell.classList.remove('chosen', 'ring-4', 'ring-blue-500', 'dark:ring-blue-400');
                            }
                            cell.addEventListener('click', () => {
                                currentSelectedTile = { r, c };
                                updateBoardSelectionUI(playerIdx);
                            });
                        }
                    }
                });
            }

            function highlightTurn(playerIdx) {
                document.querySelectorAll('#boards > div').forEach((panel, idx) => {
                    const badge = panel.querySelector('.turn-badge');
                    if (!gameOver && idx === playerIdx) {
                        panel.classList.add('ring-4', 'ring-blue-500', 'scale-105');
                        badge?.classList.remove('hidden');
                    } else {
                        panel.classList.remove('ring-4', 'ring-blue-500', 'scale-105');
                        badge?.classList.add('hidden');
                    }
                });
            }

            function disableAnswerButtons() {
                Array.from(document.getElementsByClassName('qButtons')).forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-60', 'cursor-not-allowed');
                });
            }

            function enableAnswerButtons() {
                Array.from(document.getElementsByClassName('qButtons')).forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('opacity-60', 'cursor-not-allowed');
                });
            }

            async function endGame(winnerIdx) {
                gameOver = true;
                clearInterval(timerInterval);
                disableAnswerButtons();
                highlightTurn(-1);
                showWinnerModal(playerNames[winnerIdx]);
                await window.api.endGame();
            }

            function showWinnerModal(name) {
                const modal = document.getElementById('winnerModal');
                const title = document.getElementById('winnerName');
                if (title) title.textContent = name + ' je zmagal/a! üèÜ';
                modal?.classList.remove('hidden');
            }

            // --- Toast notifications ---
            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                const text = document.getElementById('toastMessage');
                if (!toast || !text) return;
                text.textContent = message;
                toast.classList.remove('hidden');
                // style per type
                toast.classList.remove('border-green-300', 'bg-green-50', 'border-rose-300', 'bg-rose-50');
                if (type === 'success') {
                    toast.classList.add('border-green-300', 'bg-green-50');
                } else if (type === 'error') {
                    toast.classList.add('border-rose-300', 'bg-rose-50');
                }
                // auto-hide
                if (toastTimer) clearTimeout(toastTimer);
                toastTimer = setTimeout(() => {
                    toast.classList.add('hidden');
                }, 1850);
            }

            function disableAllInteraction() {
                // Disable all answer buttons
                disableAnswerButtons();
                // Disable all board panels and cells
                document.querySelectorAll('#boards > div').forEach(panel => {
                    panel.style.pointerEvents = 'none';
                    panel.style.opacity = '0.6';
                });
                // Disable timer
                if (timerInterval) clearInterval(timerInterval);
            }
        </script>

        <!-- Winner Modal -->
        <div id="winnerModal"
            class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-[90%] max-w-md text-center space-y-4">
                <h2 id="winnerName" class="text-2xl font-bold text-gray-800 dark:text-white">Zmagovalec!</h2>
                <p class="text-gray-600 dark:text-gray-300">Igra je konƒçana. ƒåestitke!</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="window.location.href='index.html'"
                        class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Nazaj na meni</button>
                    <button
                        onclick="document.getElementById('winnerModal').classList.add('hidden'); disableAllInteraction();"
                        class="px-4 py-2 rounded-lg border hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-700 dark:text-white">Zapri</button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast"
            class="hidden fixed bottom-6 right-6 z-50 px-4 py-3 rounded-xl border shadow-lg bg-white dark:bg-gray-800 flex items-center gap-3">
            <span id="toastMessage" class="text-sm text-gray-800">Message</span>
            <button onclick="document.getElementById('toast').classList.add('hidden')"
                class="text-gray-400 hover:text-gray-600">‚úñ</button>
        </div>
    </main>

    <script>
        (async () => {
            const shouldUseDark = await window.api.getTheme();
            const html = document.documentElement;
            if (shouldUseDark) {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
        })();

        window.api.onThemeChanged((shouldUseDark) => {
            const html = document.documentElement;
            if (shouldUseDark) {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
        });
    </script>
</body>

</html>